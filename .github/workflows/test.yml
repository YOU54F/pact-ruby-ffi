name: Build

on:
  push:
  workflow_dispatch:

jobs:

  github:
    timeout-minutes: 10
    strategy:
      matrix:
        os: [ubuntu-latest,windows-latest,macos-latest]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0.4'
      - run: ./script/download-libs.sh
        shell: bash
      - run: gem update bundler
        shell: bash
      - run: bundle install
        shell: bash
      - run: rake spec
        shell: bash
      - run: 
         pact/plugin/pact-plugin-cli -y install https://github.com/pactflow/pact-protobuf-plugin/releases/latest
        shell: bash
      - run: rspec examples/area_calculator/spec/pactffi_create_plugin_pact_spec.rb
        shell: bash



  # act:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v3
  #     - run: apt-get update -y  && apt-get install -y ruby-full
  #     - run: ./script/download-libs.sh
  #     - run: gem update bundler
  #     - run: bundle install
  #     - run: rake spec
  #     - run: rspec examples/area_calculator/spec/pactffi_create_plugin_pact_spec.rb















        # - name: "Installing Pact CLI Tools"
      #   run: |
      #     echo "Installing Pact CLI Tools"
      #     echo "=> downloading Pact CLI Tools"
      #     os='linux-x86_64'
      #     tag=$(basename $(curl -fs -o/dev/null -w %{redirect_url} https://github.com/pact-foundation/pact-ruby-standalone/releases/latest))
      #     filename="pact-${tag#v}-${os}.tar.gz"
      #     standalone_download_path=https://github.com/pact-foundation/pact-ruby-standalone/releases/download/${tag}/${filename}
      #     echo "from ${standalone_download_path}"
      #     curl -LO ${standalone_download_path}
      #     tar xzf ${filename}
      #     rm ${filename}
      #     echo "PATH=${PATH}:${PWD}/pact/bin/" >> $GITHUB_ENV
      # - run: pact help
      # - name: Start OSS Pact Broker
      #   run: docker-compose up -d pact-broker


            # - run: pact-broker publish pacts --auto-detect-version-properties --consumer-app-version $(git rev-parse HEAD)
      # - name: Stop OSS Pact Broker
      #   if: always()
      #   run: docker-compose down